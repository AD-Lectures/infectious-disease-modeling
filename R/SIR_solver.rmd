---
title: "Solving SIR Models"
output: html_document
---

Our goal is to observe the epidemic trajectory in a population given its $\beta$ and $\gamma$ parameters.

### Setup

First of all let's load the necessary libraries:

```{r}
library(dplyr)
library(ggplot2)
library(knitr)
library(deSolve) 
```
### Paramters and initial values

Than lets declare the epidemic parameters:

```{r}
parameters_values <- c(
  beta  = 0.5, # infectious contact rate (/person/day)
  gamma = 0.5 / 2    # recovery rate (/day) to get R_0 = 2
)
```

We need now the solving function to use with the ODE solver:

```{r}
sir_equations <- function(time, variables, parameters) {
  with(as.list(c(variables, parameters)), {
    dS <- -beta * I * S
    dI <-  beta * I * S - gamma * I
    dR <-  gamma * I
    return(list(c(dS, dI, dR)))
  })
}
```

and finally the starting point of the epidemic. For now let's consider a totally susceptible population with a small introduction event:

```{r}
initial_values <- c(
  S = .999,  # number of susceptibles at time = 0
  I =   1 - .999,  # number of infectious at time = 0
  R =   0   # number of recovered (and immune) at time = 0
)
N <- 1000
```

Finally, let's define a time period to observe:

```{r}
time_values <- seq(0, 100)
```

### Solver results

Let's run the ODE solver:

```{r}
sir_values_1 <- ode(
  y = initial_values,
  times = time_values,
  func = sir_equations,
  parms = parameters_values 
) %>% as.data.frame()
```

`r kable(head(sir_values_1))`

Use `ggplot` to create SIR visulazation function

```{r}
plot_sir <- function(SIR) {
	SIR %>% tidyr::pivot_longer(-time, names_to = 'Comp', values_to = 'Value') %>%
    ggplot(aes(time, Value, color = Comp)) +
    geom_line() +
    theme_minimal() +
    labs(x = "Time", y = "Population fraction")
}
```

and let's test it

```{r}
plot_sir(sir_values_1)
```


### Solver packaging

It may be helpful to package the SIR solver to make some experiments
```{r}
sir_fun <- function(beta, gamma, S0, I0 = 1 - S0, R0 = 0, times) {
  
# the differential equations:
  sir_equations <- function(time, variables, parameters) {
  with(as.list(c(variables, parameters)), {
    dS <- -beta * I * S
    dI <-  beta * I * S - gamma * I
    dR <-  gamma * I
    return(list(c(dS, dI, dR)))
  })
  }
  
# the parameters values:
  parameters_values <- c(beta  = beta, gamma = gamma)

# the initial values of variables:
  initial_values <- c(S = S0, I = I0, R = R0)
  
# solving
  out <- ode(initial_values, times, sir_equations, parameters_values)

# returning the output:
  as.data.frame(out)
}
```

### R_0 < 1

What would happen with R_0 < 1 even with a large initial introduction?

```{r}
sir_fun(beta = 0.4, gamma = 0.5, .8, times = seq(0, 200)) %>% 
    plot_sir()
```

### Herd immunity threshold

In this case we still use a large R_0 = 2, so the herd immunity threshold is 50%. What happens if the number of immune is below the threshold?

```{r}
sir_fun(0.5, .25, S0 = .6, I = .001, R = 0.399, times = seq(0, 200)) %>% 
    plot_sir()
```

and how does it change if the vaccination rate overcome the threshold?

```{r}
sir_fun(0.5, .25, S0 = .4, I = .001, R = 0.599, times = seq(0, 200)) %>% 
    plot_sir()
```


